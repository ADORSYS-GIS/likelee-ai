services:
  gateway:
    image: nginx:alpine
    container_name: likelee-gateway
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot-www:/var/www/certbot:ro
      - ./letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - ui
      - server
    networks:
      - likelee

  server:
    build:
      context: ../../
      dockerfile: likelee-server/Dockerfile
    container_name: likelee-server
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      RUST_LOG: info
    expose:
      - "8787"
    networks:
      - likelee

  ui:
    build:
      context: ../../
      dockerfile: likelee-ui/Dockerfile
      args:
        VITE_KEYCLOAK_URL: ${VITE_KEYCLOAK_URL}
        VITE_KEYCLOAK_REALM: ${VITE_KEYCLOAK_REALM}
        VITE_KEYCLOAK_CLIENT_ID: ${VITE_KEYCLOAK_CLIENT_ID}
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-/api}
        VITE_AWS_REGION: ${VITE_AWS_REGION}
        VITE_COGNITO_IDENTITY_POOL_ID: ${VITE_COGNITO_IDENTITY_POOL_ID}
    container_name: likelee-ui
    restart: unless-stopped
    expose:
      - "8080"
    networks:
      - likelee

  # One-shot job to obtain initial Let's Encrypt certificates
  certbot-init:
    image: certbot/certbot:latest
    container_name: likelee-certbot-init
    depends_on:
      - gateway
    volumes:
      - ./letsencrypt:/etc/letsencrypt
      - ./certbot-www:/var/www/certbot
    command: >-
      certonly --webroot --webroot-path /var/www/certbot
      --agree-tos --no-eff-email --email ${CERTBOT_EMAIL}
      -d ${DOMAIN}
      --keep-until-expiring --non-interactive

  # Daemon to renew certificates periodically
  certbot-renew:
    image: certbot/certbot:latest
    container_name: likelee-certbot-renew
    restart: unless-stopped
    depends_on:
      - gateway
    volumes:
      - ./letsencrypt:/etc/letsencrypt
      - ./certbot-www:/var/www/certbot
    entrypoint: /bin/sh
    command: -c "while :; do certbot renew --webroot -w /var/www/certbot --quiet && echo 'renew checked'; sleep 12h; done"
    networks:
      - likelee

networks:
  likelee:
    driver: bridge
